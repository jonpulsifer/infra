name: ArgoCD Diff Preview
on:
  pull_request:
    branches:
      - main
    paths:
      - 'k8s/apps/folly/**'
      - 'k8s/clusters/folly/**'
      - 'argo/**/*.tf'

env:
  ARGOCD_VERSION: v0.1.25
  ARGOCD_NAMESPACE: argo

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files: |
            k8s/apps/folly/**
            k8s/clusters/folly/**
            argo/**/*.tf

  diff-preview:
    name: Generate Diff Preview
    needs: detect-changes
    if: needs.detect-changes.outputs.files_changed == 'true'
    runs-on: [self-hosted, arc-infra-folly]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          path: target-branch
          fetch-depth: 0

      - name: Checkout base branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.base_ref }}
          path: base-branch
          fetch-depth: 0

      - name: Download argocd-diff-preview
        run: |
          curl -L -o argocd-diff-preview.tar.gz "https://github.com/dag-andersen/argocd-diff-preview/releases/download/${{ env.ARGOCD_VERSION }}/argocd-diff-preview_Linux_x86_64.tar.gz"
          tar -xzf argocd-diff-preview.tar.gz
          chmod +x argocd-diff-preview
          ./argocd-diff-preview --version

      - name: Generate Diff
        run: |
          ./argocd-diff-preview \
            --repo=${{ github.repository }} \
            --target-branch=refs/pull/${{ github.event.number }}/merge \
            --base-branch=${{ github.base_ref }} \
            --create-cluster=false \
            --argocd-namespace=${{ env.ARGOCD_NAMESPACE }} \
            --file-regex="k8s/apps/folly/.*|k8s/clusters/folly/.*|argo/.*" \
            --title="ArgoCD Diff Preview" \
            --output-folder=./output

      - name: Post diff as comment
        run: |
          if [ -f output/diff.md ] && [ -s output/diff.md ]; then
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md --edit-last || \
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md
          else
            echo "No diff generated"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
